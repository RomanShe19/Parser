services:
  avito-parser:
    build: 
      context: .
      dockerfile: Dockerfile
    container_name: avito-parser
    restart: unless-stopped
    volumes:
      # Монтируем базу данных как внешний том
      - ./database:/app/database
      # Монтируем логи
      - ./logs:/app/logs
      # Монтируем временные файлы
      - ./trash:/app/trash
    environment:
      - PYTHONUNBUFFERED=1
      - USER_AGENT=Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36
      - LOG_LEVEL=INFO
      - PARSER_DELAY=2
      env_file:
        - .env  
    # Ограничения ресурсов (для Docker Compose v2)
    mem_limit: 2g
    cpus: 1.0
    # Проверка здоровья контейнера
    healthcheck:
      test: ["CMD", "python", "-c", "import sqlite3; sqlite3.connect('/app/database/avito.db').execute('SELECT 1')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  avito-bot:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: avito-bot
    restart: unless-stopped
    command: ["python", "telegram_bot/main.py"]
    depends_on:
      - avito-parser
    volumes:
      - ./database:/app/database
      - ./logs:/app/logs
      - ./trash:/app/trash
    environment:
      - PYTHONUNBUFFERED=1
      - LOG_LEVEL=INFO
    env_file:
      - .env

